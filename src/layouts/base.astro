---
import "../styles/global.css";
import GoogleAnalytics from "../components/GoogleAnalytics.astro";
import { defaultLocale, getStrings, locales, type Locale } from "../i18n/strings";
import { siteConfig } from "../config/site";
import { pathWithLocale } from "../lib/paths";

type Props = {
  title?: string;
  description?: string;
  image?: string;
  robots?: string;
  t?: ReturnType<typeof getStrings>;
  localizedPath?: string;
  canonicalPath?: string;
  appStoreUrl?: string;
  githubUrl?: string;
  authorUrl?: string;
  privacyPath?: string;
  jsonLd?: Array<Record<string, unknown>>;
  children: any;
};

const locale = (Astro.currentLocale ?? defaultLocale) as Locale;
const strings = getStrings(locale);
const {
  title,
  description,
  image,
  robots,
  t = strings,
  localizedPath = locale === defaultLocale ? "" : `/${locale}`,
  canonicalPath,
  appStoreUrl = siteConfig.appStoreUrl,
  githubUrl = siteConfig.githubUrl,
  authorUrl = siteConfig.authorUrl,
  privacyPath,
  jsonLd = [],
  children,
} = Astro.props as Props;

const siteUrl = siteConfig.siteUrl.replace(/\/$/, "");
const pathname = Astro.url.pathname || "/";
const resolvedCanonicalPath = canonicalPath ?? pathWithLocale(locale, pathname);
const canonical = `${siteUrl}${resolvedCanonicalPath}`;
const alternateLinks = locales
  .map((lng) => ({
    href: `${siteUrl}${pathWithLocale(lng as Locale, pathname)}`,
    hrefLang: lng,
  }))
  .concat([{ href: `${siteUrl}${pathWithLocale(defaultLocale, pathname)}`, hrefLang: "x-default" }]);

const resolvedTitle = title ?? siteConfig.title;
const pageTitle = resolvedTitle.includes(siteConfig.title) ? resolvedTitle : `${resolvedTitle} â€” ${siteConfig.title}`;
const resolvedDescription = description ?? t.metaDescription ?? siteConfig.description;

const imagePath = image ?? siteConfig.image;
const ogImage = imagePath?.startsWith("http") ? imagePath : `${siteUrl}${imagePath}`;
const ogLocaleMap: Record<string, string> = { en: "en_US", ga: "ga_IE" };
const ogLocale = ogLocaleMap[locale] || "en_US";

const robotsContent = robots ?? "index,follow";
const ldGraph = [
  { "@type": "WebSite", name: siteConfig.title, url: siteUrl },
  {
    "@type": "WebPage",
    name: resolvedTitle,
    url: canonical,
    description: resolvedDescription,
    inLanguage: locale,
  },
  ...jsonLd,
];
const ld = { "@context": "https://schema.org", "@graph": ldGraph };
const measurementId = import.meta.env.PUBLIC_GTAG_ID || "G-W0BLPG9RXK";
const privacyLink = privacyPath ?? `${localizedPath}/privacy-policy/`;
---

<!DOCTYPE html>
<html lang={locale} class="scroll-smooth">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
		<link rel="manifest" href="/site.webmanifest" />
		<meta name="generator" content={Astro.generator} />
		<link rel="sitemap" href="/sitemap-index.xml" />
		{measurementId && <GoogleAnalytics measurementId={measurementId} />}
		<title>{pageTitle}</title>
		{resolvedDescription && <meta name="description" content={resolvedDescription} />}
		<meta name="robots" content={robotsContent} />
		<link rel="canonical" href={canonical} />
		<meta name="color-scheme" content="dark" />

		<meta property="og:title" content={resolvedTitle} />
		{resolvedDescription && <meta property="og:description" content={resolvedDescription} />}
		<meta property="og:type" content="website" />
		<meta property="og:url" content={canonical} />
		<meta property="og:site_name" content={siteConfig.title} />
		{ogImage && <meta property="og:image" content={ogImage} />}
		{resolvedDescription && <meta property="og:image:alt" content={resolvedDescription} />}
		<meta property="og:locale" content={ogLocale} />
		{alternateLinks
			.filter((link) => link.hrefLang !== locale && link.hrefLang !== "x-default")
			.map((alt) => (
				<meta property="og:locale:alternate" content={alt.hrefLang} />
			))}

		<meta name="twitter:card" content="summary_large_image" />
		{siteConfig.social.twitter && (
			<meta name="twitter:site" content={`@${siteConfig.social.twitter.replace(/^@/, "")}`} />
		)}
		{siteConfig.social.twitter && (
			<meta name="twitter:creator" content={`@${siteConfig.social.twitter.replace(/^@/, "")}`} />
		)}
		<meta name="twitter:title" content={resolvedTitle} />
		{resolvedDescription && <meta name="twitter:description" content={resolvedDescription} />}
		{ogImage && <meta name="twitter:image" content={ogImage} />}

		{alternateLinks.map((alt) => (
			<link rel="alternate" href={alt.href} hrefLang={alt.hrefLang} />
		))}

		<script type="application/ld+json" set:html={JSON.stringify(ld)} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:global(body) {
				font-family: "Space Grotesk", "Manrope", "DM Sans", system-ui, -apple-system, sans-serif;
				background-color: #1a0f0b;
			}
			:global(.glass-card) {
				background: linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
				border: 1px solid rgba(255, 255, 255, 0.08);
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.05);
				backdrop-filter: blur(10px);
			}
		</style>
	</head>

	<body class="min-h-screen bg-gradient-to-b from-[#1a0f0b] via-[#2c1a13] to-[#5a3f2b] text-amber-50 antialiased">
		<div class="absolute inset-0 -z-10 overflow-hidden">
			<div class="absolute -left-24 -top-24 h-72 w-72 rounded-full bg-gradient-to-br from-[#f6c899]/40 via-[#b57b4f]/40 to-transparent blur-3xl" />
			<div class="absolute inset-0 bg-[radial-gradient(circle_at_10%_20%,rgba(255,255,255,0.04),transparent_35%),radial-gradient(circle_at_90%_10%,rgba(255,255,255,0.05),transparent_30%),radial-gradient(circle_at_50%_80%,rgba(0,0,0,0.25),transparent_35%)]" />
		</div>

		<header class="relative mx-auto flex max-w-6xl flex-col items-start gap-4 px-6 py-8 md:flex-row md:items-center md:justify-between">
			<a class="flex items-center gap-3 hover:opacity-90 transition" href={`${localizedPath || "/"}`}>
				<img
					src="/Potato Game-iOS-Default-1024x1024@1x.png"
					alt="Potato Game app icon"
					class="h-12 w-12 rounded-2xl shadow-lg shadow-black/30"
					loading="lazy"
				/>
				<div>
					<p class="text-sm uppercase tracking-[0.2em] text-amber-200/70">Potato Game</p>
					<p class="text-lg font-semibold text-amber-50">{t.brandSubtitle}</p>
				</div>
			</a>
			<nav class="hidden items-center gap-6 text-sm font-semibold text-amber-100/80 md:flex">
				<a class="hover:text-amber-100" href={`${localizedPath || "/"}`}>{t.navHome ?? "Home"}</a>
				<a class="hover:text-amber-100" href={`${localizedPath}#features`}>{t.navFeatures}</a>
				<a class="hover:text-amber-100" href={privacyLink}>{t.navPrivacy}</a>
				<a class="hover:text-amber-100" href={authorUrl} rel="noreferrer">{t.navAuthor}</a>
				<a href={appStoreUrl} rel="noreferrer" class="btn btn-outline">{t.navCta}</a>
			</nav>
			<div class="md:hidden flex w-full flex-wrap items-center gap-3 text-sm">
				<a class="font-semibold text-amber-100/80 underline-offset-4 hover:underline" href={`${localizedPath || "/"}`}>
					{t.navHome ?? "Home"}
				</a>
				<a class="font-semibold text-amber-100/80 underline-offset-4 hover:underline" href={`${localizedPath}#features`}>
					{t.navFeatures}
				</a>
				<a class="font-semibold text-amber-100/80 underline-offset-4 hover:underline" href={privacyLink}>{t.navPrivacy}</a>
				<a class="font-semibold text-amber-100/80 underline-offset-4 hover:underline" href={authorUrl} rel="noreferrer">{t.navAuthor}</a>
				<a href={appStoreUrl} rel="noreferrer" class="btn btn-outline text-sm">{t.navCta}</a>
			</div>
		</header>

		<main class="relative mx-auto flex max-w-6xl flex-col gap-16 px-6 pb-20 md:pb-28">
			<slot />
		</main>

		<footer class="border-t border-white/10 bg-[#1a0f0b]/80">
			<div class="mx-auto flex max-w-6xl flex-col gap-4 px-6 py-6 text-sm text-amber-100/80 md:flex-row md:items-center md:justify-between">
				<div class="space-y-1">
					<p class="font-semibold text-amber-50">Potato Game</p>
					<p class="text-amber-100/70">{t.footerBlurb}</p>
				</div>
				<div class="flex flex-wrap items-center gap-4">
					<a class="hover:text-amber-50" href={appStoreUrl} rel="noreferrer">{t.footerLinks.appStore}</a>
					<a class="hover:text-amber-50" href={githubUrl} rel="noreferrer">{t.footerLinks.github}</a>
					<a class="hover:text-amber-50" href={authorUrl} rel="noreferrer">{t.footerLinks.author}</a>
					<a class="hover:text-amber-50" href={privacyLink}>{t.footerLinks.privacy}</a>
				</div>
			</div>
		</footer>
	</body>
</html>
